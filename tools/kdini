#!/bin/zsh
set -euo pipefail

script_path="${0:A}"
repo_dir="$(cd "$(dirname "$script_path")/.." && pwd)"
cd "$repo_dir"

usage() {
  cat <<'EOF'
kdini command toolkit

Usage:
  kdini status
  kdini pull
  kdini push "commit message"
  kdini reorganize
  kdini doctor [db_path]
  kdini inspect-sql <sql_path>
  kdini export-sql <book_id> [db_path] [out_sql]
  kdini panel [port]
  kdini panel-legacy [port]
  kdini menu
  kdini open <path>
  kdini help
EOF
}

cmd="${1:-help}"
if [[ $# -gt 0 ]]; then
  shift
fi

case "$cmd" in
  status)
    git status --short -b
    echo
    git log --oneline -n 5
    ;;

  pull)
    branch="$(git branch --show-current)"
    git pull --rebase origin "$branch"
    ;;

  push)
    message="${*:-}"
    ./tools/git_quick_push.sh "$message"
    ;;

  reorganize)
    ./tools/reorganize_assets.sh
    ;;

  doctor)
    db_path="${1:-/Users/kerim/Documents/kdini/kdini/assets/books.db}"
    python3 ./tools/data_ops.py --repo-root "$repo_dir" doctor --db "$db_path"
    ;;

  export-sql)
    book_id="${1:-}"
    db_path="${2:-/Users/kerim/Documents/kdini/kdini/assets/books.db}"
    out_sql="${3:-$repo_dir/kotob/book_${book_id}.sql}"
    meta_out="${out_sql%.sql}.book.json"

    if [[ -z "$book_id" ]]; then
      echo "Missing <book_id>."
      usage
      exit 1
    fi

    python3 ./tools/data_ops.py --repo-root "$repo_dir" export-sql \
      --db "$db_path" \
      --book-id "$book_id" \
      --out "$out_sql" \
      --meta-out "$meta_out"
    ;;

  inspect-sql)
    sql_path="${1:-}"
    if [[ -z "$sql_path" ]]; then
      echo "Missing <sql_path>."
      usage
      exit 1
    fi
    python3 ./tools/data_ops.py --repo-root "$repo_dir" inspect-sql --sql "$sql_path"
    ;;

  panel)
    port="${1:-8890}"
    ./tools/start_filament_panel.sh "$port"
    ;;

  panel-legacy)
    port="${1:-8787}"
    ./tools/start_panel.sh "$port"
    ;;

  menu)
    ./tools/manage_menu.sh
    ;;

  open)
    file_path="${1:-}"
    if [[ -z "$file_path" ]]; then
      echo "Missing file path."
      usage
      exit 1
    fi
    open "$repo_dir/$file_path"
    ;;

  help|-h|--help)
    usage
    ;;

  *)
    echo "Unknown command: $cmd"
    usage
    exit 1
    ;;
esac
